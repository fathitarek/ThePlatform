<?phpnamespace App\Http\Controllers\Admin;use App\AppUsers;use App\Countries;use Illuminate\Http\Request;use App\Http\Controllers\Controller;use Illuminate\Support\Facades\Hash;use Illuminate\Support\Facades\Input;use Illuminate\Support\Facades\Validator;use Illuminate\Support\Facades\Auth;use Illuminate\Support\Facades\Session;use Illuminate\Support\Facades\Lang;use Illuminate\Support\Facades\Redirect;class AppUsersController extends Controller{    //    public function index(Request $request)    {        //        $data=$request->input();        $search=$request->input('search');        if($search){            $app_users=AppUsers::where('name','LIKE',"%$search%")->orderBy('id','DESC')->paginate(100);            $app_users->AppUsers(['search'=>$search]);        }else{            $app_users=AppUsers::orderBy('app_users.id','DESC')->get();        }        return view('auth.app_users.view',compact('app_users'));    }    /**     * Show the form for creating a new resource.     *     * @return \Illuminate\Http\Response     */    public function create()    {        //        $countries=Countries::where('active',1)->get();        $appUsers=AppUsers::where('active',1)->where('parent_id',0)->get();        return view('auth.app_users.add',compact('countries','appUsers'));    }    /**     * Store a newly created resource in storage.     *     * @param  \Illuminate\Http\Request  $request     * @return \Illuminate\Http\Response     */    public function store(Request $request)    {        //        $data=$request->input();        $validator = Validator::make($request->all(),            array(                'time_zone'=>'required',                'country_id'=>'required',                'name'=>'required',                'email'=>'required|unique:app_users,email',                'phone'=>'required|unique:app_users,phone',                'password'=>'required',                'confirm_password'=>'required|same:password',                'type'=>'required|in:company,personal',            ));        if ($validator->fails()) {            return redirect()->back()->withErrors($validator->errors())->withInput();        }else {            $active=(isset($data['active']))?1:0;            $app_users=new AppUsers();            $app_users->time_zone=$data['time_zone'];            $app_users->country_id=$data['country_id'];            $app_users->name=$data['name'];            $app_users->email=$data['email'];            $app_users->phone=$data['phone'];            $app_users->password=Hash::make($data['password']);            $app_users->type=$data['type'];            $app_users->parent_id=(isset($data['parent_id']))?$data['parent_id']:'';            if(Input::hasFile('image')){                $validator = Validator::make($request->all(),array(                    'image' => 'required|mimes:jpeg,bmp,png'                ));                if ($validator->fails()) {                    return redirect()->back()->withErrors($validator->errors())->withInput();                }else{                    $file=$request->file('image');                    $image=FileImage($file,'app_users');                    $app_users->img=$image['img'];                    $app_users->img_dir=$image['img_dir'];                }            }            $app_users->active=$active;            if($active==1){                $app_users->active_by=Auth::user()->id;                $app_users->active_date=date("Y-m-d H:i:s");            }            if($active==0){                $app_users->unactive_by=Auth::user()->id;                $app_users->unactive_date=date("Y-m-d H:i:s");            }            $app_users->add_by=Auth::user()->id;            $app_users->add_date=date("Y-m-d H:i:s");            if($app_users->save()){                Session::flash('success', Lang::get('main.insert').Lang::get('main.app_users'));                return Redirect::to('admin/app_users/create');            }        }    }    /**     * Display the specified resource.     *     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function show($id)    {        //        return abort(404);    }    /**     * Show the form for editing the specified resource.     *     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function edit($id)    {        //        $post=AppUsers::find($id);        if(count($post)){            $post=makeDefaultImage($post,'app_users');            $countries=Countries::where('active',1)->get();            $appUsers=AppUsers::where('active',1)->where('parent_id',0)->where('id','!=',$id)->get();            return view('auth.app_users.edit',compact('post','countries','appUsers'));        }else{            return abort(404);        }    }    /**     * Update the specified resource in storage.     *     * @param  \Illuminate\Http\Request  $request     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function update(Request $request, $id)    {        //        $data=$request->input();        $app_users= AppUsers::find($id);        if(count($app_users)){            $validator = Validator::make($request->all(),                array(                    'country_id'=>'required',                    'time_zone'=>'required',                    'name'=>'required',                    'email'=>'required|unique:app_users,email',                    'phone'=>'required|unique:app_users,phone',                    'password'=>'required',                    'confirm_password'=>'required|same:password',                    'type'=>'required|in:company,personal',                ));            if ($validator->fails()) {                return redirect()->back()->withErrors($validator->errors())->withInput();            }else {                if(!empty($data['password'])){                    $validator = Validator::make($request->all(),                        array(                            'password'=>'required|min:6',                            'confirm_password'=>'required|same:password',                        ));                    if ($validator->fails()) {                        return redirect()->back()->withErrors($validator->errors())->withInput();                    }else {                        $app_users->password=Hash::make($data['password']);                    }                }                if(Input::hasFile('image')){                    $validator = Validator::make($request->all(),array(                        'image' => 'required|mimes:jpeg,bmp,png'                    ));                    if ($validator->fails()) {                        return redirect()->back()->withErrors($validator->errors())->withInput();                    }else{                        if(file_exists(public_path().$app_users->img_dir.$app_users->img)&&!empty($app_users->img_dir)){                            unlink(public_path().$app_users->img_dir.$app_users->img);                        }                        if(file_exists(public_path().$app_users->img_dir.'thumbnail/thumbnail_'.$app_users->img)&&!empty($app_users->img_dir)){                            unlink(public_path().$app_users->img_dir.'thumbnail/thumbnail_'.$app_users->img);                        }                        $file=$request->file('image');                        $image=FileImage($file,'app_users');                        $app_users->img=$image['img'];                        $app_users->img_dir=$image['img_dir'];                    }                }                $active=(isset($data['active']))?1:0;                $app_users->country_id=$data['country_id'];                $app_users->time_zone=$data['time_zone'];                $app_users->name=$data['name'];                $app_users->email=$data['email'];                $app_users->phone=$data['phone'];                $app_users->type=$data['type'];                $app_users->parent_id=(isset($data['parent_id']))?$data['parent_id']:'';                if($active==1&&$app_users->active==0){                    $app_users->active_by=Auth::user()->id;                    $app_users->active_date=date("Y-m-d H:i:s");                }                if($active==0&&$app_users->active==1){                    $app_users->unactive_by=Auth::user()->id;                    $app_users->unactive_date=date("Y-m-d H:i:s");                }                $app_users->active=$active;                $app_users->lastedit_by=Auth::user()->id;                $app_users->lastedit_date=date("Y-m-d H:i:s");                if($app_users->save()){                    Session::flash('success', Lang::get('main.update').Lang::get('main.app_users'));                    return Redirect::to('admin/app_users/'.$id.'/edit');                }            }        }else{            return abort(404);        }    }    /**     * Remove the specified resource from storage.     *     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function destroy($id)    {        //        $app_users=AppUsers::find($id);        if(count($app_users)){            $app_users->deleted_by=Auth::user()->id;            $app_users->save();            $app_users->delete();        }    }    public function activation(Request $request){        if($request->ajax()){            $id=$request->input('id');            $active=$request->input('active');            $app_users=AppUsers::find($id);            if ($active == 0) {                $app_users->active = 0;                $app_users->unactive_by = Auth::user()->id;                $app_users->unactive_date = date("Y-m-d H:i:s");            } elseif ($active == 1) {                $app_users->active = 1;                $app_users->active_by = Auth::user()->id;                $app_users->active_date = date("Y-m-d H:i:s");            }            $app_users->save();        }else{            return abort(404);        }    }}